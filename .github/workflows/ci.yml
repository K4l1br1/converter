name: CI

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  build-and-test:
    name: Build, Test, Package and Upload Artifacts
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Install build dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
            build-essential g++ make \
            dpkg-dev debhelper fakeroot \
            rpm

    - name: Build project
      run: make -j"$(nproc)"

    - name: Build tests
      run: make test

    - name: Run unit tests
      run: |
        echo "Running test runner..."
        if [ -f ./test_runner ]; then
          chmod +x ./test_runner
          ./test_runner
        elif [ -f ./tests/test_runner ]; then
          chmod +x ./tests/test_runner
          ./tests/test_runner
        else
          echo "ERROR: test_runner not found"
          exit 1
        fi

    - name: Build .deb package
      id: build_deb
      run: |
        if [ -f ./build_deb.sh ]; then
          chmod +x ./build_deb.sh
          ./build_deb.sh
        else
          echo "No build_deb.sh — skipping"
        fi

    - name: Build .rpm package
      id: build_rpm
      run: |
        if [ -f ./build_rpm.sh ]; then
          chmod +x ./build_rpm.sh
          ./build_rpm.sh
        else
          echo "No build_rpm.sh — skipping"
        fi

    - name: Collect build outputs
      run: |
        mkdir -p artifacts
        cp -v ./*.deb artifacts/ 2>/dev/null || true
        cp -v ./*.rpm artifacts/ 2>/dev/null || true
        cp -v ./unit_converter artifacts/ 2>/dev/null || true
        cp -v ./test_runner artifacts/ 2>/dev/null || true

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: unit_converter
        path: artifacts/
        retention-days: 30
        if-no-files-found: warn

    - name: Install .deb or fallback install
      run: |
        DEB=$(ls *.deb 2>/dev/null || true)
        RPM=$(ls *.rpm 2>/dev/null || true)
        if [ -n "$DEB" ]; then
          sudo dpkg -i "$DEB" \
            || (sudo apt-get -f install -y && sudo dpkg -i "$DEB")
        elif [ -n "$RPM" ]; then
          sudo rpm -i "$RPM" || true
        else
          sudo make install
        fi

